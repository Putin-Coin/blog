<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<link rel="subresource" src="//use.typekit.net/ayq0lpd.js"/>
<link rel="subresource" src="//www.google-analytics.com/analytics.js"/>

<title>What No One Told You About Z-Index &mdash; Philip Walton</title>

<!--[if lt IE 9]><script src="/assets/javascript/html5shiv.js"></script><![endif]-->

<!-- Put typekit in the head for the fastest possible download. -->
<script src="//use.typekit.net/ayq0lpd.js"></script>

<script>
ga = function() { ga.q.push(arguments); };
ga.q = []; ga.l = 1 * new Date();

// Create the GA tracker before doing any logging.
ga('create', 'UA-21292978-1', 'auto');



  // In non-production mode, simply log GA hits to the console.
  ga(function(tracker) {
    tracker.set('sendHitTask', function() {
      // Throw to stop subsequent tasks.
      throw 'Abort tracking in non-production environments.'
    });
  });



// Initialize typekit and track how frequently it fails.
try {
  Typekit.load();
}
catch(err) {
  ga('send', 'exception', {
    exDescription: err.stack || err.message,
    exFatal: false
  });
}


// Track uncaught errors via Google Analytics.
window.onerror = function(message, url, line, col) {
  var desc = message + ' (line: ' + line + ', url: ' + url + ', col: '
      + col + ')';
  ga('send', 'exception', {
    exDescription: 'window.onerror: ' + desc,
    exFatal: false
  });
};


// Note, tasks must be set before sending the first hit
ga('send', 'pageview');
</script>


<link href="/assets/css/style.css" rel="stylesheet">
<link href="http://feeds.feedburner.com/philipwalton" rel="alternate" title="Philip Walton" type="application/atom+xml">

<meta name="description" content="The problem with z-index is that very few people understand how it really works. It’s not">
<meta name="viewport" content="width=device-width, initial-scale=1">

<svg display="none">
  <defs>
    <path id="icon-twitter-bird" d="M34.7 5c1.7-1 2.8-2.5 3.4-4.4-1.6 0.9-3.3 1.6-5 2-1.6-1.7-3.6-2.6-5.8-2.6-2.2 0-4.2 0.7-5.7 2.3-1.6 1.6-2.3 3.4-2.3 5.8 0 0.6 0.1 1.2 0.2 1.8-6.9-0.4-12.6-3.2-16.9-8.5-0.7 1.2-1.1 2.7-1.1 4.1 0 3 1.2 5.2 3.6 6.8-1.2 0-2.5-0.4-3.6-1v0.1c0 2 0.6 3.7 1.8 5.2 1.2 1.5 2.7 2.5 4.6 2.8-0.6 0.1-1.2 0.2-2.1 0.2-0.4 0-0.9 0-1.5-0.1 0.5 1.5 1.4 2.8 2.8 3.8 1.4 1 3 1.5 4.7 1.6-3.1 2.5-6.4 3.7-10 3.7-0.5 0-1.1 0-2-0.1 3.7 2.2 7.8 3.4 12.4 3.4 3.6 0 6.8-0.7 9.8-2.1 3-1.4 5.4-3.2 7.3-5.4 1.8-2.2 3.3-4.7 4.3-7.4s1.6-5.4 1.6-8.1v-1c1.4-1 2.7-2.5 3.9-4.2-1.6 0.6-3.2 1.1-4.7 1.2z"></path>
    <path id="icon-rss" d="M16 0q6.6 0 11.3 4.7t4.7 11.3q0 6.6-4.7 11.3t-11.3 4.7-11.3-4.7-4.7-11.3 4.7-11.3 11.3-4.7zM10.7 24q1.1 0 1.9-0.8t0.8-1.9-0.8-1.9-1.9-0.8-1.9 0.8-0.8 1.9 0.8 1.9 1.9 0.8zM16.7 24h3.3q0-5-3.5-8.5t-8.5-3.5v3.3q3.6 0 6.1 2.5t2.5 6.1zM22.7 24h3.3q0-3.7-1.4-7t-3.8-5.7-5.7-3.8-7-1.4v3.3q6.1 0 10.4 4.3t4.3 10.4z"></path>
    <path id="icon-twitter" d="M16 0q6.6 0 11.3 4.7t4.7 11.3-4.7 11.3-11.3 4.7-11.3-4.7-4.7-11.3 4.7-11.3 11.3-4.7zM25.7 12.5q1.2-0.9 2.3-2.3-1.3 0.6-2.6 0.7 1.4-0.8 2-2.5-1.4 0.8-2.9 1.1-1.3-1.4-3.3-1.4-1.9 0-3.2 1.3t-1.3 3.2q0 0.6 0.1 1-5.7-0.3-9.4-4.8-0.6 1.1-0.6 2.3 0 2.4 2 3.8-1 0-2-0.6v0q0 1.6 1 2.9t2.6 1.6q-0.5 0.1-1.2 0.1-0.3 0-0.9-0.1 0.4 1.4 1.6 2.2t2.6 0.9q-2.6 2.1-5.6 2.1-0.4 0-1.1-0.1 3.1 2 7 2 3 0 5.5-1.2t4.1-3.1 2.4-4.1 0.9-4.6v-0.6z"></path>
    <path id="icon-github" d="M16 0q6.59 0 11.3 4.7t4.7 11.3q0 5.52-3.39 9.85t-8.61 5.67v-4.18q0-2.89-1.67-4.18 3.37-0.52 5.52-2.41t2.15-4.74q0-2.52-1.85-4.59 0.67-3.07-0.15-4.74-2.04 0.19-4.63 1.78-1.78-0.44-3.37-0.44t-3.37 0.44q-2.59-1.59-4.63-1.78-0.85 1.78-0.15 4.74-1.85 2.07-1.85 4.59 0 2.85 2.15 4.74t5.52 2.41q-0.85 0.63-1.3 1.82-0.67 0-1.37-0.13t-1.28-0.35-1.11-0.5-0.96-0.56-0.72-0.52-0.48-0.39l-0.15-0.15q-0.26-0.26-0.52-0.07-0.3 0.19-0.22 0.52 0.7 1.37 1.19 2 1.93 2.48 5.26 3.48v3.22q-5.22-1.33-8.61-5.67t-3.39-9.85q0-6.63 4.68-11.31t11.32-4.68z"></path>
  </defs>
</svg>


  </head>
  <body class="Site">

    <div class="Site-header">
      <header class="Header">
        <a class="Header-info" href="/" title="Home">
          <h1 class="Header-title">Philip Walton</h1>
          <p class="Header-tagline">Engineer at Google</p>
        </a>
        <a class="Header-photo" href="/" title="Home"></a>
        <div class="Header-social">
          <nav class="SocialNav">
  <a class="SocialNav-icon SocialNav-icon--twitter"
     href="https://twitter.com/philwalton"
     title="Twitter">
    <svg viewBox="0 0 32 32">
      <use xlink:href="#icon-twitter"></use>
    </svg>
  </a>
  <a class="SocialNav-icon SocialNav-icon--github"
     href="https://github.com/philipwalton"
     title="Github">
    <svg viewBox="0 0 32 32">
      <use xlink:href="#icon-github"></use>
    </svg>
  </a>
  <a class="SocialNav-icon SocialNav-icon--rss"
     href="http://feeds.feedburner.com/philipwalton"
     title="RSS">
    <svg viewBox="0 0 32 32">
      <use xlink:href="#icon-rss"></use>
    </svg>
  </a>
</nav>
        </div>
        <div class="Header-nav">
          <nav class="MainNav">
  <a href="/" title="Home">Home</a>
  <a href="/articles/" title="Articles">Articles</a>
  <a href="/about/" title="About">About</a>
</nav>
        </div>
      </header>
    </div>

    <div class="Site-contentContainer">
      <main class="Site-content">
        
<article role="article" class="hentry">

  <header class="ContentHeader">
    <h1 class="ContentHeader-title entry-title">What No One Told You About Z-Index</h1>
    <time class="ContentHeader-date published"
        datetime="2012-12-22T21:17:39-08:00">
      December 22, 2012
    </time>
  </header>

  <div class="entry-content">
    <p>The problem with z-index is that very few people understand how it really works. It’s not complicated, but it if you’ve never taken the time to read its specification, there are almost certainly crucial aspects that you’re completely unaware of.</p>
<p>Don’t believe me? Well, see if you can solve this problem:</p>
<h2 id="the-problem">The Problem</h2>
<p>In the following HTML you have three <code>&lt;div&gt;</code> elements, and each <code>&lt;div&gt;</code> contains a single <code>&lt;span&gt;</code> element. Each <code>&lt;span&gt;</code> is given a background color &mdash; red, green, and blue respectively. Each <code>&lt;span&gt;</code> is also positioned absolutely near the top left of the document, slightly overlapping the other <code>&lt;span&gt;</code> elements so you can see which ones are stacked in front of which. The first <code>&lt;span&gt;</code> has a z-index value of <code>1</code>, while the other two do not have any z-index set.</p>
<p>Here’s what the HTML and basic CSS look like. I’ve also included a visual demo (via <a href="http://codepen.io">Codepen</a>) with the full CSS below:</p>
<pre class="highlight"><code class="xml"><span class="tag">&lt;<span class="title">div</span>&gt;</span>
  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"red"</span>&gt;</span>Red<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
<span class="tag">&lt;<span class="title">div</span>&gt;</span>
  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"green"</span>&gt;</span>Green<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
<span class="tag">&lt;<span class="title">div</span>&gt;</span>
  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"blue"</span>&gt;</span>Blue<span class="tag">&lt;/<span class="title">span</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span></code></pre><pre class="highlight"><code class="css"><span class="class">.red</span>, <span class="class">.green</span>, <span class="class">.blue</span> <span class="rules">{
  <span class="rule"><span class="attribute">position</span>:<span class="value"> absolute</span></span>;
<span class="rule">}</span></span>
<span class="class">.red</span> <span class="rules">{
  <span class="rule"><span class="attribute">background</span>:<span class="value"> red</span></span>;
  <span class="rule"><span class="attribute">z-index</span>:<span class="value"> <span class="number">1</span></span></span>;
<span class="rule">}</span></span>
<span class="class">.green</span> <span class="rules">{
  <span class="rule"><span class="attribute">background</span>:<span class="value"> green</span></span>;
<span class="rule">}</span></span>
<span class="class">.blue</span> <span class="rules">{
  <span class="rule"><span class="attribute">background</span>:<span class="value"> blue</span></span>;
<span class="rule">}</span></span></code></pre><div class="CodepenContainer">
  <iframe src="//codepen.io/philipwalton/embed/ksBaI?height=250&theme-id=5742" scrolling="no" frameborder="0" height="250" allowtransparency="true"></iframe>
</div>

<p><strong>Here’s the challenge:</strong> try to see if you can make the red <code>&lt;span&gt;</code> element stack behind the blue and green <code>&lt;span&gt;</code> elements without breaking any of the following rules:</p>
<ul>
<li>Do not alter the HTML markup in any way.</li>
<li>Do not add/change the z-index property of any element.</li>
<li>Do not add/change the position property of any element.</li>
</ul>
<p>To see if you can figure it out, click the <em>edit on Codepen</em> link above and play around with it for a bit. If you’ve succeeded, it should look like the example below.</p>
<p><em>Warning: Don’t click on the CSS tab of the example below or it will give away the answer.</em></p>
<div class="CodepenContainer">
  <iframe src="//codepen.io/philipwalton/embed/dfCtb?height=250&theme-id=5742" scrolling="no" frameborder="0" height="250" allowtransparency="true"></iframe>
</div>


<h2 id="the-solution">The Solution</h2>
<p>The solution is to add an opacity value less than <code>1</code> to the first <code>&lt;div&gt;</code> (the parent of the red <code>&lt;span&gt;</code>). Here is the CSS that was added to the Codepen above:</p>
<pre class="highlight"><code class="css"><span class="tag">div</span><span class="pseudo">:first-child</span> <span class="rules">{
  <span class="rule"><span class="attribute">opacity</span>:<span class="value"> .<span class="number">99</span></span></span>;
<span class="rule">}</span></span></code></pre><p>If you’re scratching your head right now in shock and disbelief that opacity would have any effect on which elements are stacked in front of which, welcome to the club. I was similarly shocked when I first stumbled upon this issue.</p>
<p>Hopefully the rest of this article will make things a little more clear.</p>
<h2 id="stacking-order">Stacking Order</h2>
<p>Z-index seems so simple: elements with a higher z-index are stacked in front of elements with a lower z-index, right? Well, actually, no. This is part of the problem with z-index. It appears so simple, so most developers don’t take the time to read the rules.</p>
<p>Every element in an HTML document can be either in front of or behind every other element in the document. This is known as the stacking order. The rules to determine this order are pretty clearly defined in the spec, but as I’ve already stated, they’re not fully understood by most developers.</p>
<p>When the z-index and position properties aren’t involved, the rules are pretty simple: basically, the stacking order is the same as the order of appearance in the HTML. (OK, it’s actually a <a href="http://www.w3.org/TR/CSS2/zindex.html">little more complicated</a> than that, but as long as you’re not using negative margins to overlap inline elements, you probably won’t encounter the edge cases.)</p>
<p>When you introduce the position property into the mix, any positioned elements (and their children) are displayed in front of any non-positioned elements. (To say an element is “positioned” means that it has a position value other than <code>static</code>, e.g., <code>relative</code>, <code>absolute</code>, etc.)</p>
<p>Finally, when z-index is involved, things get a little trickier. At first it’s natural to assume elements with higher z-index values are in front of elements with lower z-index values, and any element with a z-index is in front of any element without a z-index, but it’s not that simple. First of all, z-index only works on positioned elements. If you try to set a z-index on an element with no position specified, it will do nothing. Secondly, z-index values can create stacking contexts, and now suddenly what seemed simple just got a lot more complicated.</p>
<h2 id="stacking-contexts">Stacking Contexts</h2>
<p>Groups of elements with a common parent that move forward or backward together in the stacking order make up what is known as a stacking context. A full understanding of stacking contexts is key to really grasping how z-index and the stacking order work.</p>
<p>Every stacking context has a single HTML element as its root element. When a new stacking context is formed on an element, that stacking context confines all of its child elements to a particular place in the stacking order. That means that if an element is contained in a stacking context at the bottom of the stacking order, there is no way to get it to appear in front of another element in a different stacking context that is higher in the stacking order, even with a z-index of a billion!</p>
<p>New stacking contexts can be formed on an element in one of three ways:</p>
<ul>
<li>When an element is the root element of a document (the <code>&lt;html&gt;</code> element)</li>
<li>When an element has a position value other than <code>static</code> and a z-index value other than <code>auto</code></li>
<li>When an element has an opacity value less than <code>1</code></li>
</ul>
<p>The first and second ways to form stacking context make a lot of sense and are generally understood by Web developers (even if they don’t know what they’re called).</p>
<p>The third way (opacity) is almost never mentioned outside of w3c specification documents.</p>
<p class="callout">
  <strong>Update:</strong> In addition to opacity, several newer CSS properties also create stacking contexts. These include: <a href="http://www.w3.org/TR/css3-transforms/">transforms</a>, <a href="http://www.w3.org/TR/filter-effects/">filters</a>, <a href="http://www.w3.org/TR/css3-regions/">css-regions</a>, <a href="http://www.w3.org/TR/css3-page/">paged media</a>, and possibly others. As a general rule, it seems that if a CSS property requires rendering in an offscreen context, it must create a new stacking context.
</p>

<h2 id="determining-an-element-s-position-in-the-stacking-order">Determining an Element’s Position in the Stacking Order</h2>
<p>Actually determining the global stacking order for all elements on a page (including borders, backgrounds, text nodes, etc.) is extremely complicated and far beyond the scope of this article (again, I refer you to <a href="http://www.w3.org/TR/CSS2/zindex.html">the spec</a>).</p>
<p>But for most intents and purposes, a basic understanding of the order can go a long way and help keep CSS development predictable. So let’s start by breaking the order down into individual stacking contexts.</p>
<h3 id="stacking-order-within-the-same-stacking-context">Stacking Order Within the Same Stacking Context</h3>
<p>Here are the basic rules to determine stacking order within a single stacking context (from back to front):</p>
<ol>
<li>The stacking context’s root element</li>
<li>Positioned elements (and their children) with negative z-index values (higher values are stacked in front of lower values; elements with the same value are stacked according to appearance in the HTML)</li>
<li>Non-positioned elements (ordered by appearance in the HTML)</li>
<li>Positioned elements (and their children) with a z-index value of <code>auto</code> (ordered by appearance in the HTML)</li>
<li>Positioned elements (and their children) with positive z-index values (higher values are stacked in front of lower values; elements with the same value are stacked according to appearance in the HTML)</li>
</ol>
<p><strong>Note:</strong> positioned elements with negative z-indexes are ordered first within a stacking context, which means they appear behind all other elements. Because of this, it becomes possible for an element to appear behind its own parent, which is normally not possible. This will only work if the element’s parent is in the same stacking context and is not the root element of that stacking context. A great example of this is Nicolas Gallagher’s <a href="http://nicolasgallagher.com/css-drop-shadows-without-images/demo/">CSS drop-shadows without images</a>.</p>
<h3 id="global-stacking-order">Global Stacking Order</h3>
<p>With a firm understanding of how/when new stacking contexts are formed as well as a grasp of the stacking order within a stacking context, figuring out where a particular element will appear in the global stacking order isn’t so bad.</p>
<p>The key to avoid getting tripped up is being able to spot when new stacking contexts are formed. If you’re setting a z-index of a billion on an element and it’s not moving forward in the stacking order, take a look up its ancestor tree and see if any of its parents form stacking contexts. If they do, your z-index of a billion isn’t going to do you any good.</p>
<h2 id="wrapping-up">Wrapping Up</h2>
<p>Getting back to the original problem, I’ve recreated the HTML structure adding comments within each tag indicating its place in the stacking order. This order is assuming the original CSS.</p>
<pre class="highlight"><code class="xml"><span class="tag">&lt;<span class="title">div</span>&gt;</span><span class="comment">&lt;!-- 1 --&gt;</span>
  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"red"</span>&gt;</span><span class="comment">&lt;!-- 6 --&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
<span class="tag">&lt;<span class="title">div</span>&gt;</span><span class="comment">&lt;!-- 2 --&gt;</span>
  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"green"</span>&gt;</span><span class="comment">&lt;!-- 4 --&gt;</span><span class="tag">&lt;<span class="title">span</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
<span class="tag">&lt;<span class="title">div</span>&gt;</span><span class="comment">&lt;!-- 3 --&gt;</span>
  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"blue"</span>&gt;</span><span class="comment">&lt;!-- 5 --&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span></code></pre><p>When we add the opacity rule to the first <code>&lt;div&gt;</code>, the stacking order changes like so:</p>
<pre class="highlight"><code class="xml"><span class="tag">&lt;<span class="title">div</span>&gt;</span><span class="comment">&lt;!-- 1 --&gt;</span>
  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"red"</span>&gt;</span><span class="comment">&lt;!-- 1.1 --&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
<span class="tag">&lt;<span class="title">div</span>&gt;</span><span class="comment">&lt;!-- 2 --&gt;</span>
  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"green"</span>&gt;</span><span class="comment">&lt;!-- 4 --&gt;</span><span class="tag">&lt;<span class="title">span</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
<span class="tag">&lt;<span class="title">div</span>&gt;</span><span class="comment">&lt;!-- 3 --&gt;</span>
  <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"blue"</span>&gt;</span><span class="comment">&lt;!-- 5 --&gt;</span><span class="tag">&lt;/<span class="title">span</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span></code></pre><p><code>span.red</code> used to be <code>6</code> but it’s changed to <code>1.1</code>. I’ve used dot notation to show that a new stacking context was formed and <code>span.red</code> is now the first element within that new context.</p>
<p>Hopefully it’s now a little more clear why the red box moved behind the other boxes. The original example contained only two stacking contexts, the root one and the one formed on <code>span.red</code>. When we added opacity to the parent element of <code>span.red</code> we formed a third stacking context and, as a result, the z-index value on <code>span.red</code> only applied within that new context. Because the first <code>&lt;div&gt;</code> (the one we applied opacity to) and its sibling elements do not have position or z-index values set, their stacking order is determined by their source order in the HTML, which means the first <code>&lt;div&gt;</code>, and all the elements contained within its stacking context, are rendered behind the second and third <code>&lt;div&gt;</code> elements.</p>
<h2 id="additional-resources">Additional Resources</h2>
<ul>
<li><a href="http://www.w3.org/TR/CSS2/zindex.html">Elaborate description of Stacking Contexts</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/CSS/Understanding_z-index/The_stacking_context">The stacking context</a></li>
<li><a href="http://coding.smashingmagazine.com/2009/09/15/the-z-index-css-property-a-comprehensive-look/">The Z-Index CSS Property: A Comprehensive Look</a></li>
</ul>

  </div>

  <footer class="entry-unrelated">

    <div class="Share">
      <span class="Share-figure">
        <svg viewBox="0 0 39 32">
          <use xlink:href="#icon-twitter-bird"></use>
        </svg>
      </span>
      <p class="Share-pitch">
        If you liked this article and think others should read it, please
        <a data-social-network="Twitter"
           data-social-action="tweet"
           href="http://twitter.com/intent/tweet?text=What%20No%20One%20Told%20You%20About%20Z-Index&amp;url=http%3A%2F%2Fphilipwalton.com%2Farticles%2Fwhat-no-one-told-you-about-z-index%2F&amp;via=philwalton">share it on Twitter</a>.
      </p>
    </div>

  </footer>

</article>

      </main>
    </div>

    <script>
(function(window, document, location) {
  (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
module.exports = function(element, event, fn) {
  if (element.addEventListener) {
    element.addEventListener(event, fn, false);
  }
  else {
    element.attachEvent('on' + event, fn);
  }
};

},{}],2:[function(require,module,exports){
/* global ga */

var linkClicked = require('./link-clicked');
var History2 = require('./history2');
var parseUrl = require('./parse-url');

// Cache the container element to avoid multiple lookups.
var container;

// Store the result of page content requests to avoid multiple
// lookups when navigation to a previously seen page.
var pageCache = {};


function getTitle(a) {
  var title = a.title || a.innerText;
  return title ? title + ' \u2014 Philip Walton' : null;
}


function loadPageContent(done) {
  var path = this.nextPage.path;

  if (pageCache[path]) return done();

  var basename = /(\w+)\.html$/;
  var url = basename.test(path) ?
      path.replace(basename, '_$1.html') : path + '_index.html';

  var xhr = new XMLHttpRequest();
  xhr.open('GET', url);
  xhr.onload = function() {
    if (xhr.status >= 200 && xhr.status < 400) {
      pageCache[path] = xhr.responseText;
      done();
    }
    else {
      done(new Error('(' + xhr.status + ') ' + xhr.response));
    }
  };
  xhr.onerror = function() {
    done(new Error('Error making request to:' + url));
  };
  xhr.send();
}


function showPageContent() {
  var content = pageCache[this.nextPage.path];
  container.innerHTML = content;
}


function setScroll() {
  var hash = this.nextPage.hash;
  if (hash) {
    var target = document.getElementById(hash.slice(1));
  }
  var scrollPos = target ? target.offsetTop : 0;

  // TODO: There's a weird chrome bug were sometime this function
  // doesn't do anything if Chrome has already visited this page and
  // thinks it has a scroll position in mind. Just chrome, weird...
  window.scrollTo(0, scrollPos);
}


function trackPage() {
  ga('set', {
    location: this.nextPage.href,
    title: this.nextPage.title
  });
  ga('send', 'pageview');

}


function trackError(error) {
  var url = this.nextPage.href;
  ga('send', 'exception', {
    exDescription: error.stack || error.message,
    exFatal: false,
    hitCallback: function() {
      // If there's an error, attempt to manually navigation to the
      // page. If that fails Github pages will show the actual 404 page.
      location.href = url;
    }
  });
}


module.exports = {

  init: function() {

    // Only load external content via AJAX if the browser support pushState.
    if (!(window.history && window.history.pushState)) return;

    // Add the current page to the cache.
    container = document.querySelector('main');
    pageCache[location.pathname] = container.innerHTML;


    var history2 = new History2()
        .use(loadPageContent)
        .use(showPageContent)
        .use(setScroll)
        .use(trackPage)
        ['catch'](trackError);

    linkClicked(function(event) {

      // Don't attempt to AJAX in content if the link was click
      // while the command (meta) or control key was pressed.
      if (event.metaKey || event.ctrlKey) return;

      var page = parseUrl(location.href);
      var link = parseUrl(this.href);

      // Don't do anything when clicking on links to the current URL.
      if (link.href == page.href) event.preventDefault();

      // If the clicked link is on the same site but has a different path,
      // prevent the browser from navigating there and load the page via ajax.
      if ((link.origin == page.origin) && (link.path != page.path)) {
        event.preventDefault();
        history2.add(link.href, getTitle(this));
      }
    });
  }
};

},{"./history2":3,"./link-clicked":4,"./parse-url":7}],3:[function(require,module,exports){
var parseUrl = require('./parse-url');

function History2() {

  // Store the current url information.
  this.currentPage = parseUrl(window.location.href);
  this.currentPage.title = document.title;

  // Add history state initially so the first `popstate` event contains data.
  history.replaceState(
      this.currentPage,
      this.currentPage.title,
      this.currentPage.href);

  this._queue = [];

  // Listen for popstate changes and log them.
  window.addEventListener('popstate', function(event) {
    var state = event.state;
    var title = state && state.title;
    this.add(window.location.href, title, state, event);
  }.bind(this));
}


History2.prototype.add = function(url, title, state, event) {

  // Ignore urls pointing to the current address
  if (url == this.currentPage.href) return;

  this.nextPage = parseUrl(url);
  this.nextPage.title = title;
  this.nextPage.state = state;

  this._processQueue(event);
};


/**
 * Register a plugin with the History2 instance.
 * @param {Function(History2, done)} - A plugin that runs some task and
 *     informs the next plugin in the queue when it's done.
 */
History2.prototype.use = function(plugin) {
  this._queue.push(plugin);

  return this;
};

/**
 * Register a handler to catch any errors.
 * Note: In ES3 reserved words like "catch" couldn't be used as property names:
 * http://kangax.github.io/compat-table/es5/#Reserved_words_as_property_names
 * @param {Function(Error)} - The function to handle the error.
 */
History2.prototype['catch'] = function(onError) {
  this._onError = onError;

  return this;
};


History2.prototype._onError = function(error) {
  // Left blank so calling `_onError` never fails.
  console.error(error.stack);
};


History2.prototype._onComplete = function(event) {

  // Popstate triggered navigation is already handled by the browser,
  // so we only add to the history in non-popstate cases.
  if (!(event && event.type == 'popstate')) {
    history.pushState(
        this.nextPage,
        this.nextPage.title,
        this.nextPage.href);
  }

  if (this.nextPage.title) document.title = this.nextPage.title;

  // Update the last url to the current url
  this.currentPage = this.nextPage;
  this.nextPage = null;
};


History2.prototype._processQueue = function(event) {
  var self = this;
  var i = 0;

  (function next() {

    var plugin = self._queue[i++];
    var isSync = plugin && !plugin.length;

    if (!plugin) return self._onComplete(event);

    // The callback for async plugins.
    function done(error) {
      if (error) {
        self._onError(error);
      }
      else {
        next();
      }
    }

    try {
      plugin.apply(self, isSync ? [] : [done]);
    }
    catch(error) {
      return self._onError(error);
    }

    // Sync plugins are done by now and can immediately process
    // the next item in the queue.
    if (isSync) next();

  }());
};


module.exports = History2;

},{"./parse-url":7}],4:[function(require,module,exports){
var addListener = require('./add-listener');

function isLink(el) {
  return el.nodeName && el.nodeName.toLowerCase() == 'a' && el.href;
}

function getLinkAncestor(el) {
  if (isLink(el)) return el;
  while (el.parentNode && el.parentNode.nodeType == 1) {
    if (isLink(el)) return el;
    el = el.parentNode;
  }
}

module.exports = function(fn) {
  addListener(document, 'click', function(event) {
    var e = event || window.event;
    var target = e.target || e.srcElement;
    var link = getLinkAncestor(target);
    if (link) {
      fn.call(link, e);
    }
  });
};

},{"./add-listener":1}],5:[function(require,module,exports){
var supports = require('./supports');
var outboundLinks = require('./outbound-links');
var socialInteractions = require('./social-interactions');
var contentLoader = require('./content-loader');


// Add an `is-legacy` class on browsers that don't supports flexbox.
if (!supports.flexbox()) {
  document.documentElement.className += ' is-legacy';
}


// Track when the user clicks a link to an external site.
outboundLinks.track();


// Track when the user clicks a social link.
socialInteractions.track();


// Load links via AJAX instead of full page loads in browsers with pushState.
contentLoader.init();

},{"./content-loader":2,"./outbound-links":6,"./social-interactions":8,"./supports":9}],6:[function(require,module,exports){
/* global ga */

var parseUrl = require('./parse-url');
var linkClicked = require('./link-clicked');

function isExternalLink(link) {
  var url = parseUrl(link.href);
  var loc = parseUrl(location.href);
  return url.origin != loc.origin;
}

module.exports = {
  track: function() {
    linkClicked(function() {
      if (isExternalLink(this)) {

        // Opening links in an external tabs allows the ga beacon to send.
        // When following links directly, sometimes they don't make it.
        this.target = '_blank';

        ga('send', 'event', 'Outbound Link', 'click', this.href);
      }
    });

  }
};


},{"./link-clicked":4,"./parse-url":7}],7:[function(require,module,exports){
var a = document.createElement('a');
var cache = {};

/**
 * Parse the given url and return the properties returned
 * by the `Location` object.
 * @param {string} url - The url to parse.
 * @return {Object} An object with the same keys as `window.location`.
 */
module.exports = function(url) {

  if (cache[url]) return cache[url];

  var httpPort = /:80$/;
  var httpsPort = /:443/;

  a.href = url;

  // Sometimes IE will return no port or just a colon, especially for things
  // like relative port URLs (e.g. "//google.com").
  var protocol = !a.protocol || ':' == a.protocol ?
      location.protocol : a.protocol;

  // Don't include default ports.
  var port = (a.port == '80' || a.port == '443') ? '' : a.port;

  // Sometimes IE incorrectly includes a port (e.g. `:80` or `:443`)  even
  // when no port is specified in the URL.
  // http://bit.ly/1rQNoMg
  var host = a.host.replace(protocol == 'http:' ? httpPort : httpsPort, '');

  // Not all browser support `origin` so we have to build it.
  var origin = a.origin ? a.origin : protocol + '//' + host;

  // Sometimes IE doesn't include the leading slash for pathname.
  // http://bit.ly/1rQNoMg
  var pathname = a.pathname.charAt(0) == '/' ? a.pathname : '/' + a.pathname;

  return cache[url] = {
    hash: a.hash,
    host: host,
    hostname: a.hostname,
    href: a.href,
    origin: origin,
    path: pathname + a.search,
    pathname: pathname,
    port: port,
    protocol: protocol,
    search: a.search
  };
};

},{}],8:[function(require,module,exports){
/* global ga */

var linkClicked = require('./link-clicked');

module.exports = {
  track: function() {
    linkClicked(function() {
      var socialNetwork = this.getAttribute('data-social-network');
      if (socialNetwork) {
        var socialAction = this.getAttribute('data-social-action');
        var socialTarget = location.href;

        // Opening links in an external tabs allows the ga beacon to send.
        // When following links directly, sometimes they don't make it.
        this.target = '_blank';

        ga('send', 'social', socialNetwork, socialAction, socialTarget);
      }
    });
  }
};

},{"./link-clicked":4}],9:[function(require,module,exports){
var supports = {};
var style = document.body.style;

module.exports = {
  flexbox: function() {
    return supports.flexbox || (supports.flexbox = ('flexBasis' in style ||
        'msFlexAlign' in style || 'webkitBoxDirection' in style));
  }
};

},{}]},{},[5]);

}(window, document, location));
</script>

<!-- Load GA after the `window.ga` is initialized or you'll get errors. -->


  <script async src="//www.google-analytics.com/analytics_debug.js"></script>



  </body>
</html>
